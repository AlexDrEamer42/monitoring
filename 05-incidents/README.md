# Домашнее задание к занятию 17 «Инцидент-менеджмент»

# Постмортем на основе сбоя системы GitHub 21.10.2018 г.

## Краткое описание инцидента

21.10.2018 г. на нескольких сервисах GitHub.com пострадали несколько сетевых разделов. Вследствие этого произошёл сбой базы данных.

## Предшествующие события

В 22:52 UTC 21 октября плановые работы по замене отказавшего оптического оборудования 100 Гбит/с привели к потере связи в течение 43 секунд между сетевым узлом на Восточном побережье США и основным центром обработки данных на Восточном побережье США. 

## Причина инцидента

Кратковременный перебой вызвал цепь перебоев в работе сети.

Во время отсутствия связи Orchestrator, который был активен в основном ЦОДе, начал процесс списания лидеров в соответствии с консенсусом Raft. Узлы Orchestrator в центре обработки данных на Западном побережье США и в публичном облаке на Восточном побережье США смогли создать кворум и запустить отказоустойчивые кластеры, чтобы направить запись в центр обработки данных на Западном побережье США. Далее Orchestrator приступил к организации топологий кластеров баз данных Западного побережья США. Когда связь была восстановлена, уровень приложений сразу же начал направлять трафик записи на новые первичные узлы на Западном побережье. 

Серверы баз данных в центре обработки данных на Восточном побережье США в течение короткого периода времени содержали записи, которые не были реплицированы в центр на Западном побережье США. Поскольку кластеры баз данных в обоих центрах обработки данных теперь содержали записи, которых не было в другом центре обработки данных, не получилось безопасно перевести основной сервер в центр обработки данных на Восточном побережье США.

## Воздействие на клиентов

На сайте GitHub.com появлялась противоречивая (устаревшая и неконсистентная) информация. Напрмиер, при создании Issue и комментариев записи о них отображались, но после перезагрузки страницы пропадали. 

## Обнаружение 

Внутренние системы мониторинга начали генерировать оповещения, свидетельствующие о многочисленных сбоях в работе систем. В это время несколько инженеров отвечали на запросы и занимались сортировкой поступающих уведомлений. К 23:02 UTC инженеры команды первого реагирования определили, что топологии многочисленных кластеров баз данных находятся в нестандартном состоянии. Запрос к API Orchestrator показал топологию репликации баз данных, в которую входили только серверы из центра обработки данных на Западном побережье США.

## Реакция

Команда реагирования решила вручную заблокировать внутренние средства развертывания, чтобы предотвратить внесение дополнительных изменений. В 23:09 UTC команда реагирования перевела сайт в желтый статус. Это действие автоматически перевело ситуацию в активный инцидент и отправило оповещение координатору инцидента. В 23:11 UTC координатор инцидента подключился и через две минуты принял решение об изменении статуса на красный.

Были вызваны дополнительные инженеры из команды GitHub, занимающиеся разработкой баз данных. Они приступили к изучению текущей ситуации, чтобы определить, какие действия необходимо предпринять для ручной настройки базы данных Восточного побережья США в качестве основной для каждого кластера и восстановления топологии репликации. 

Обновили статус, сообщили пользователям, что будет выполняться контролируемый обход отказа внутренней системы хранения данных.

## Восстановление

Было проведено восстановление данных из резервных копий, синхронизация реплик на обоих сайтах, возврат к стабильной топологии обслуживания и возобновление обработки заданий в очереди. 

В процессе восстановления была произведена приостановка работы веб-хуков и других внутренних систем обработки (сборка GitHub Pages).

## Таймлайн

2018 October 21 22:52 UTC - потеря связи между сетевым узлом и основным центром обработки данных на Восточном побережье США.

2018 October 21 22:52 UTC - Orchestrator создал отказоустойчивый кластер с центром обработки данных на Западном побережье США.

2018 October 21 22:54 UTC - системы мониторинга обнаружили сбой.

2018 October 21 23:02 UTC - инженеры команды первого реагирования обнаружили изменения в топологии репликации.

2018 October 21 23:07 UTC - ответственная команда решила вручную заблокировать внутренние средства развертывания, чтобы предотвратить внесение дополнительных изменений.

2018 October 21 23:09 UTC - группа реагирования перевела сайт в желтый статус. Это действие автоматически перевело ситуацию в статус активного инцидента и отправило сигнал тревоги координатору инцидента.

2018 October 21 23:09 UTC - подключился координатор инцидента.

2018 October 21 23:11 UTC - координатор инцидента принял решение об изменении статуса на красный.

2018 October 21 23:13 UTC - к решения индидента подключились инженеры, занимающиеся разработкой баз данных.

2018 October 21 23:19 UTC - приостановлена доставка веб-хуков и сборка GitHub Pages.

2018 October 22 00:05 UTC - инженеры, участвовавшие в ликвидации последствий инцидента, приступили к разработке плана по устранению инцидента. Выполнено уведомление пользователей о текущем статусе инцидента.

2018 October 22 00:41 UTC - запущен процесс резервного копирования всех затронутых кластеров MySQL.

2018 October 22 06:51 UTC - несколько кластеров завершили восстановление из резервных копий в центре обработки данных на Восточном побережье США и начали реплицировать новые данные с Западного побережья. Была обновлена страница статуса инцидента.

2018 October 22 07:46 UTC - в блоге опубликован пост с подробной информацией об инциденте.

2018 October 22 11:12 UTC - все первичные базы данных на Восточном побережье США восстановлены.

2018 October 22 13:15 UTC - нагрузка на GitHub.com приблизилась к пиковой. Команда реагирования на инциденты обсудила, как действовать дальше.

2018 October 22 16:24 UTC - произведен возврат на исходную топологию, устранены проблемы с задержкой и доступностью. Сохранён красный статус сервиса на время обработки накопленных данных.

2018 October 22 16:45 UTC - обработано 200 000 веб-хуков из очереди, увеличен TTL для просроченных веб-хуков.

2018 October 22 23:03 UTC - обработаны все оставшиеся веб-хуки и сборки GitHub Pages, подтверждена целостность и работоспособность всех систем. Статус сайта обновлен до зеленого.

## Последующие действия

1. Настроить конфигурацию Orchestrator таким образом, чтобы предотвратить продвижение первичных баз данных через региональные границы. 
2. Ускорить переход на новый механизм отчетности о статусе сервисов, который позволит четче и яснее излагать информацию об активных инцидентах.
3. Повысить приоритет реализации общекорпоративной инженерной инициативы по поддержке обслуживания трафика GitHub из нескольких центров обработки данных по схеме active/active/active.
4. Применять системную практику проверки сценариев отказов до того, как они смогут повлиять на пользователей. 

